name: Auto Update with Bun
on:
  workflow_call:
    inputs:
      commands:
        type: string
        required: false
        default: '["fmt", "typegen", "db:generate"]'
        description: |
          JSON å½¢å¼ã®å®Ÿè¡Œã™ã‚‹ã‚³ãƒãƒ³ãƒ‰ã®é…åˆ— (e.g. '["fmt","typegen"]')

jobs:
  auto-update:
    name: Auto Update
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v5
      - uses: oven-sh/setup-bun@v2

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Run Commands
        id: run-commands
        uses: actions/github-script@v8
        with:
          script: |
            const { execSync } = require('child_process');
            const commands = JSON.parse('${{ inputs.commands }}');

            console.log('ğŸ“¦ bun ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œä¸­...');

            // Gitè¨­å®š
            execSync('git config --local user.email "github-actions[bot]@users.noreply.github.com"');
            execSync('git config --local user.name "github-actions[bot]"');

            // ãƒ–ãƒ©ãƒ³ãƒåã‚’ç”Ÿæˆ
            const timestamp = new Date().toISOString().replace(/[:.]/g, '').replace('T', '').substring(0, 19);
            const branchName = `auto-update/bun-${timestamp}`;

            // æ–°ã—ã„ãƒ–ãƒ©ãƒ³ãƒã‚’ä½œæˆ
            execSync(`git checkout -b ${branchName}`);
            console.log(`ğŸ“ ãƒ–ãƒ©ãƒ³ãƒä½œæˆ: ${branchName}`);

            let totalChanges = false;

            // å„ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ã‚³ãƒŸãƒƒãƒˆ
            for (const cmd of commands) {
              console.log(`\nğŸ”§ å®Ÿè¡Œä¸­: bun run ${cmd}`);
              try {
                const output = execSync(`bun run ${cmd}`, {
                  encoding: 'utf-8',
                  stdio: 'pipe'
                });
                console.log(output);

                // ã“ã®ã‚³ãƒãƒ³ãƒ‰ã«ã‚ˆã‚‹å¤‰æ›´ã‚’ç¢ºèª
                const gitStatus = execSync('git status --porcelain', { encoding: 'utf-8' });
                if (gitStatus.trim().length > 0) {
                  // å¤‰æ›´ã‚’ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°
                  execSync('git add -A');

                  // ã‚³ãƒŸãƒƒãƒˆ
                  const commitMessage = `chore: bun run ${cmd} ã«ã‚ˆã‚‹è‡ªå‹•æ›´æ–°\n\nCo-authored-by: ${{ github.actor }} <${{ github.actor }}@users.noreply.github.com>`;
                  execSync(`git commit -m "${commitMessage}"`);

                  console.log(`âœ… ã‚³ãƒŸãƒƒãƒˆä½œæˆ: ${cmd} ã«ã‚ˆã‚‹å¤‰æ›´`);
                  totalChanges = true;
                } else {
                  console.log(`ğŸ“­ ${cmd} ã«ã‚ˆã‚‹å¤‰æ›´ã¯ã‚ã‚Šã¾ã›ã‚“`);
                }
              } catch (error) {
                console.error(`âš ï¸ ã‚³ãƒãƒ³ãƒ‰ãŒå¤±æ•—ã—ã¾ã—ãŸ: ${cmd}`);
                console.error(error.message);
                // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã‚‚ä»–ã®ã‚³ãƒãƒ³ãƒ‰ã¯ç¶™ç¶šå®Ÿè¡Œ
              }
            }

            if (totalChanges) {
              console.log('\nâœ… åˆè¨ˆã§å¤‰æ›´ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ');
              core.setOutput('changes', 'true');
              core.setOutput('branch', branchName);
            } else {
              console.log('\nğŸ“­ å¤‰æ›´ã¯ã‚ã‚Šã¾ã›ã‚“');
              core.setOutput('changes', 'false');
            }

            return totalChanges;

      - name: Create Pull Request
        if: steps.run-commands.outputs.changes == 'true'
        uses: actions/github-script@v8
        env:
          BASE_REF: ${{ github.head_ref || github.ref_name }}
        with:
          github-token: ${{ github.token }}
          script: |
            const { execSync } = require('node:child_process');

            const branchName = `${{ steps.run-commands.outputs.branch }}`;
            const baseRef = process.env.BASE_REF;

            // ãƒ–ãƒ©ãƒ³ãƒã‚’ãƒ—ãƒƒã‚·ãƒ¥
            try {
              execSync(`git push origin "${branchName}"`, { stdio: 'inherit' });
            } catch (e) {
              core.setFailed(`ãƒ–ãƒ©ãƒ³ãƒã® push ã«å¤±æ•—ã—ã¾ã—ãŸ: ${e.message}`);
              return;
            }

            // PR ã‚’ä½œæˆ
            const title = `chore: è‡ªå‹•æ›´æ–°`;
            const body = `ã“ã®PRã¯GitHub Actionsã«ã‚ˆã£ã¦è‡ªå‹•çš„ã«ä½œæˆã•ã‚Œã¾ã—ãŸ\n\nCo-authored-by: ${context.actor} <${context.actor}@users.noreply.github.com>`;

            const { owner, repo } = context.repo;
            const { data: pr } = await github.rest.pulls.create({
              owner,
              repo,
              title,
              head: branchName,
              base: baseRef,
              body,
            });

            core.info(`âœ… Pull Request ãŒä½œæˆã•ã‚Œã¾ã—ãŸ: ${pr.html_url}`);
            core.error(`è‡ªå‹•æ›´æ–°ã«ã‚ˆã‚‹å¤‰æ›´ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚ä½œæˆã•ã‚ŒãŸPRã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¦ãã ã•ã„: ${pr.html_url}`);
            core.setFailed('è‡ªå‹•æ›´æ–°ã«ã‚ˆã‚Šå¤‰æ›´ãŒç™ºç”Ÿã—ã¾ã—ãŸ');

      - name: Comment on PR (pull_request event)
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v8
        with:
          github-token: ${{ github.token }}
          script: |
            const { owner, repo } = context.repo;
            const issue_number = context.payload.pull_request.number;
            const body = `è‡ªå‹•æ›´æ–°ã«ã‚ˆã‚‹å¤‰æ›´ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚ä½œæˆã•ã‚ŒãŸPRã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¦ãã ã•ã„: ${context.payload.pull_request.html_url}`;

            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number,
              body,
            });
