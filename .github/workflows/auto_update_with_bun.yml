name: Auto Update with Bun
on:
  workflow_call:
    inputs:
      commands:
        type: string
        required: false
        default: '["fmt", "typegen", "db:generate"]'
        description: |
          JSON å½¢å¼ã®å®Ÿè¡Œã™ã‚‹ã‚³ãƒãƒ³ãƒ‰ã®é…åˆ— (e.g. '["fmt","typegen"]')

    secrets:
      GH_APPS_APP_ID:
        required: true
        description: |
          Push ã‚’è¡Œã† GitHub Apps ã® APP ID.
          NWU bot ã‚’ä½¿ç”¨ã™ã‚‹å ´åˆã¯ä¸‹è¨˜ã‹ã‚‰ç¢ºèª
          https://github.com/organizations/nw-union/settings/apps/nwu-bot

      GH_APPS_PRIVATE_KEY:
        required: true
        description: |
          Push ã‚’è¡Œã† GitHub Apps ã® Private Key.
          NWU bot ã‚’ä½¿ç”¨ã™ã‚‹å ´åˆã¯ä¸‹è¨˜ã‹ã‚‰ç¢ºèª
          https://github.com/organizations/nw-union/settings/apps/nwu-bot

jobs:
  auto-update:
    name: Auto Update
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/create-github-app-token@v2
        id: github-app-token
        with:
          app-id: ${{ secrets.GH_APPS_APP_ID }}
          private-key: ${{ secrets.GH_APPS_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }} # For creating a token for all repositories in the current owner's installation

      - uses: actions/checkout@v5
        with:
          ref: ${{ github.head_ref || github.ref_name }}
          token: ${{ steps.github-app-token.outputs.token }}

      - uses: oven-sh/setup-bun@v2
      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Run Commands And Push
        uses: actions/github-script@v8
        with:
          script: |
            const { execSync } = require('child_process');
            const commands = JSON.parse('${{ inputs.commands }}');

            console.log('ğŸ“¦ bun ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œä¸­...');

            // Gitè¨­å®š
            execSync('git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"');
            execSync('git config --local user.name "github-actions[bot]"');

            let totalChanges = false;

            // å„ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ã‚³ãƒŸãƒƒãƒˆ
            for (const cmd of commands) {
              console.log(`\nğŸ”§ å®Ÿè¡Œä¸­: bun run ${cmd}`);
              try {
                const output = execSync(`bun run ${cmd}`, {
                  encoding: 'utf-8',
                  stdio: 'pipe'
                });
                console.log(output);

                // ã“ã®ã‚³ãƒãƒ³ãƒ‰ã«ã‚ˆã‚‹å¤‰æ›´ã‚’ç¢ºèª
                const gitStatus = execSync('git status --porcelain', { encoding: 'utf-8' });
                if (gitStatus.trim().length > 0) {
                  // ã‚³ãƒŸãƒƒãƒˆ
                  execSync('git add -A');
                  // ã‚³ãƒãƒ³ãƒ‰ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³å¯¾ç­–: cmdã‚’ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
                  const escapedCmd = cmd.replace(/'/g, "'\\''");
                  const commitMessage = `chore: bun run ${escapedCmd} ã«ã‚ˆã‚‹è‡ªå‹•æ›´æ–°\n\nCo-authored-by: ${{ github.actor }} <${{ github.actor }}@users.noreply.github.com>`;
                  execSync(`git commit -m '${commitMessage}'`);

                  console.log(`âœ… ã‚³ãƒŸãƒƒãƒˆä½œæˆ: ${cmd} ã«ã‚ˆã‚‹å¤‰æ›´`);
                  totalChanges = true;
                } else {
                  console.log(`ğŸ“­ ${cmd} ã«ã‚ˆã‚‹å¤‰æ›´ã¯ã‚ã‚Šã¾ã›ã‚“`);
                }
              } catch (error) {
                core.setFailed(`âš ï¸ ã‚³ãƒãƒ³ãƒ‰ãŒå¤±æ•—ã—ã¾ã—ãŸ: ${cmd}. error: ${error.message}`);
              }
            }

            // å¤‰æ›´ãŒã‚ã‚Œã° push
            if (totalChanges) {
              // push
              console.log('\nâœ… å¤‰æ›´ãŒæ¤œå‡ºã•ã‚ŒãŸã®ã§ push ã‚’ã—ã¾ã™');
              execSync(`git push origin HEAD`, { stdio: 'inherit' });

              core.setFailed('è‡ªå‹•æ›´æ–°ã«ã‚ˆã‚Šå·®åˆ†ãŒç™ºç”Ÿã—ãŸãŸã‚å¤±æ•—ã¨ã—ã¦çµ‚äº†ã—ã¾ã™');
            } else {
              console.log('\nğŸ“­ å¤‰æ›´ã¯ã‚ã‚Šã¾ã›ã‚“');
            }
