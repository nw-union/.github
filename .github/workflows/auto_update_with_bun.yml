name: Auto Update with Bun
on:
  workflow_call:
    inputs:
      commands:
        type: string
        required: false
        default: '["fmt", "typegen", "db:generate"]'
        description: |
          JSON å½¢å¼ã®å®Ÿè¡Œã™ã‚‹ã‚³ãƒãƒ³ãƒ‰ã®é…åˆ— (e.g. '["fmt","typegen"]')

jobs:
  auto-update:
    name: Auto Update
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v5
      - uses: oven-sh/setup-bun@v2

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Run Commands
        id: run-commands
        uses: actions/github-script@v7
        with:
          script: |
            const { execSync } = require('child_process');
            const commands = JSON.parse('${{ inputs.commands }}');

            console.log('ğŸ“¦ bun ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œä¸­...');

            // å„ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œ
            for (const cmd of commands) {
              console.log(`\nğŸ”§ å®Ÿè¡Œä¸­: bun run ${cmd}`);
              try {
                const output = execSync(`bun run ${cmd}`, {
                  encoding: 'utf-8',
                  stdio: 'pipe'
                });
                console.log(output);
              } catch (error) {
                console.error(`âš ï¸ ã‚³ãƒãƒ³ãƒ‰ãŒå¤±æ•—ã—ã¾ã—ãŸ: ${cmd}`);
                console.error(error.message);
                // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã‚‚ä»–ã®ã‚³ãƒãƒ³ãƒ‰ã¯ç¶™ç¶šå®Ÿè¡Œ
              }
            }

            // å¤‰æ›´ã‚’ç¢ºèª
            const gitStatus = execSync('git status --porcelain', { encoding: 'utf-8' });
            const hasChanges = gitStatus.trim().length > 0;

            if (hasChanges) {
              console.log('\nâœ… å¤‰æ›´ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ');
              core.setOutput('changes', 'true');
            } else {
              console.log('\nğŸ“­ å¤‰æ›´ã¯ã‚ã‚Šã¾ã›ã‚“');
              core.setOutput('changes', 'false');
            }

            return hasChanges;

      - name: Commit and Push Changes
        if: steps.run-commands.outputs.changes == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          # ã™ã¹ã¦ã®å¤‰æ›´ã‚’ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°
          git add -A

          # ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä½œæˆï¼ˆãƒ’ã‚¢ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§ã¯ãªã -m ã‚’ä½¿ç”¨ï¼‰
          git commit \
            -m "chore: bun ã‚³ãƒãƒ³ãƒ‰ã«ã‚ˆã‚‹è‡ªå‹•æ›´æ–°" \
            -m "" \
            -m "Co-authored-by: ${{ github.actor }} <${{ github.actor }}@users.noreply.github.com>"

          # ç¾åœ¨ã®ãƒ–ãƒ©ãƒ³ãƒã«ãƒ—ãƒƒã‚·ãƒ¥
          git push origin HEAD
