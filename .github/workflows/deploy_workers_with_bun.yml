name: Deploy Workers With Bun
on:
  workflow_call:
    inputs:
      command:
        type: string
        default: deploy

      envs:
        type: string
        required: false
        default: '["production"]'
        description: |
          json å½¢å¼ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ç’°å¢ƒã®é…åˆ— (e.g. '["production","development"]')

      artifacts-upload-path:
        type: string
        required: false
        default: build/

      artifacts-download-path:
        type: string
        required: false
        default: build/
        description: |
          æˆæœç‰©ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ãƒ‘ã‚¹.
          upload-path ãŒè¤‡æ•°ã®æ™‚ã¯ãã®è¦ªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’æŒ‡å®š. $GITHUB_WORKSPACE ãªã©.

    secrets:
      CLOUDFLARE_ACCOUNT_ID:
        required: true
        description: |
          Cloudflare ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆID.
          Cloudflare ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ > Workers & Pages > Overview ã§,
          å³å´ã®ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‹ã‚‰ç¢ºèªå¯èƒ½.

      CLOUDFLARE_API_TOKEN:
        required: true
        description: |
          Cloudflare ã® API ãƒˆãƒ¼ã‚¯ãƒ³.
          Cloudflare ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ > My Profile > API Tokens ã§ä½œæˆ.
          å¿…è¦ãªæ¨©é™(å¤šåˆ†):
            - Account > Workers Scripts > Edit
            - Account > Workers KV Storage > Edit (KV ã‚’ä½¿ã†å ´åˆ)
            - Zone > Workers Routes > Edit (ã‚«ã‚¹ã‚¿ãƒ ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’ä½¿ã†å ´åˆ)

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v2

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Build
        run: bun run build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          include-hidden-files: true
          path: ${{ inputs.artifacts-upload-path }}

  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    needs: build
    strategy:
      matrix:
        environment: ${{ fromJSON(inputs.envs) }}
    outputs:
      status: ${{ steps.output.outputs.deploy-status }}
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v2

      - name: Install dependencies # TODO: ç„¡ãã—ãŸã„
        run: bun install --frozen-lockfile

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts
          path: ${{ inputs.artifacts-download-path }}

      - name: Deploy
        id: deploy
        uses: cloudflare/wrangler-action@v3
        with:
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          command: ${{ inputs.command }} --env ${{ matrix.environment }}

      - name: Set output
        id: output
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const deploymentData = {
              environment: '${{ matrix.environment }}',
              status: '${{ steps.deploy.outcome }}',
              url: '${{ steps.deploy.outputs.deployment-url }}' || 'N/A'
            };

            core.setOutput('deploy-status', JSON.stringify(deploymentData));

  result:
    name: Result
    runs-on: ubuntu-latest
    needs: deploy
    if: always()
    steps:
      - name: Generate deployment message
        id: message
        uses: actions/github-script@v7
        with:
          script: |
            const results = ${{ toJSON(needs.deploy.outputs) }};

            let message = '## ğŸš€ Deployment Results\n\n';
            message += '| Environment | Status | URL |\n';
            message += '| :---------- | :----- | :-- |\n';

            // å„ç’°å¢ƒã®çµæœã‚’è§£æã—ã¦ message ã«è¿½åŠ 
            Object.values(results).forEach(result => {
              const data = JSON.parse(result);
              const statusEmoji = data.status === 'success' ? 'âœ…' : 'âŒ';
              message += `| ${data.environment} | ${statusEmoji} ${data.status} | ${data.url} |\n`;
            });

            // Base64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã—ã¦outputã«ä¿å­˜ï¼ˆæ”¹è¡Œã‚’ä¿æŒã™ã‚‹ãŸã‚ï¼‰
            const messageBase64 = Buffer.from(message).toString('base64');
            core.setOutput('message', messageBase64);

      - name: Write Summary
        uses: actions/github-script@v7
        with:
          script: |
            const messageBase64 = '${{ steps.message.outputs.message }}';
            const message = Buffer.from(messageBase64, 'base64').toString('utf-8');

            // GitHub Actions Summary ã«æ›¸ãè¾¼ã‚€
            await core.summary
              .addRaw(message)
              .write();

      - name: Comment on PR
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request' # PR ã®å ´åˆã¯ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ®‹ã™
        with:
          script: |
            const messageBase64 = '${{ steps.message.outputs.message }}';
            const message = Buffer.from(messageBase64, 'base64').toString('utf-8');

            // PRç”¨ã®æƒ…å ±ã¨ãƒœãƒƒãƒˆã‚³ãƒ¡ãƒ³ãƒˆã®è­˜åˆ¥å­ã‚’è¿½åŠ 
            const body = message +
              `\n*Pusher: @${{ github.actor }}, Commit: ${{ github.event.pull_request.head.sha }}* \n` +
              `\n<!-- deploy-workers-with-bun-results -->`;


            // æ—¢å­˜ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ¢ã™
            const comments = await github.rest.issues.listComments({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo
            });

            const botComment = comments.data.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('<!-- deploy-workers-with-bun-results -->')
            );

            if (botComment) {
              // æ—¢å­˜ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ›´æ–°
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              // æ–°è¦ã‚³ãƒ¡ãƒ³ãƒˆã‚’ä½œæˆ
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: body
              });
            }
