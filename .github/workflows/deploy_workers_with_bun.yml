name: Deploy Workers With Bun
on:
  workflow_call:
    inputs:
      command:
        type: string
        default: deploy

      envs:
        type: string
        required: false
        default: '["production"]'
        description: |
          json å½¢å¼ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ç’°å¢ƒã®é…åˆ— (e.g. '["production","development"]')

      artifacts-upload-path:
        type: string
        required: false
        default: build/

      artifacts-download-path:
        type: string
        required: false
        default: build/
        description: |
          æˆæœç‰©ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ãƒ‘ã‚¹.
          upload-path ãŒè¤‡æ•°ã®æ™‚ã¯ãã®è¦ªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’æŒ‡å®š. $GITHUB_WORKSPACE ãªã©.

    secrets:
      CLOUDFLARE_ACCOUNT_ID:
        required: true
        description: |
          Cloudflare ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆID.
          Cloudflare ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ > Workers & Pages > Overview ã§,
          å³å´ã®ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‹ã‚‰ç¢ºèªå¯èƒ½.

      CLOUDFLARE_API_TOKEN:
        required: true
        description: |
          Cloudflare ã® API ãƒˆãƒ¼ã‚¯ãƒ³.
          Cloudflare ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ > My Profile > API Tokens ã§ä½œæˆ.
          å¿…è¦ãªæ¨©é™(å¤šåˆ†):
            - Account > Workers Scripts > Edit
            - Account > Workers KV Storage > Edit (KV ã‚’ä½¿ã†å ´åˆ)
            - Zone > Workers Routes > Edit (ã‚«ã‚¹ã‚¿ãƒ ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’ä½¿ã†å ´åˆ)

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
      - uses: oven-sh/setup-bun@v2

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Build
        run: bun run build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          include-hidden-files: true
          path: ${{ inputs.artifacts-upload-path }}

  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    needs: build
    strategy:
      matrix:
        environment: ${{ fromJSON(inputs.envs) }}
    steps:
      - uses: actions/checkout@v5
      - uses: oven-sh/setup-bun@v2

      - name: Install dependencies # TODO: ç„¡ãã—ãŸã„
        run: bun install --frozen-lockfile

      - name: Download build artifacts
        uses: actions/download-artifact@v5
        with:
          name: build-artifacts
          path: ${{ inputs.artifacts-download-path }}

      - name: Deploy
        id: deploy
        uses: cloudflare/wrangler-action@v3
        with:
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          command: ${{ inputs.command }} --env ${{ matrix.environment }}

      - name: Save deployment result
        if: always()
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');
            const data = {
              environment: '${{ matrix.environment }}',
              status: '${{ steps.deploy.outcome }}',
              url: '${{ steps.deploy.outputs.deployment-url }}' || 'N/A'
            };
            fs.writeFileSync('result.json', JSON.stringify(data));

      - name: Upload deployment result
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: deploy-result-${{ matrix.environment }}
          path: result.json

  result:
    name: Result
    runs-on: ubuntu-latest
    needs: deploy
    if: always()
    steps:
      - name: Download deployment results
        uses: actions/download-artifact@v5
        with:
          pattern: deploy-result-*
          path: results

      - name: Generate deployment message
        id: message
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            let message = '## ğŸš€ Deployment Results\n\n';
            message += '| Environment | Status | URL |\n';
            message += '| :---------- | :----- | :-- |\n';

            const dir = 'results';
            const files = fs.readdirSync(dir);

            files.forEach(file => {
              let filePath;
              const fullPath = path.join(dir, file);
              
              // ãƒ•ã‚¡ã‚¤ãƒ«ã‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‹ã‚’åˆ¤å®š
              if (fs.statSync(fullPath).isDirectory()) {
                // è¤‡æ•°ç’°å¢ƒã®å ´åˆï¼šresults/deploy-result-env/result.json
                filePath = path.join(fullPath, 'result.json');
              } else {
                // å˜ä¸€ç’°å¢ƒã®å ´åˆï¼šresults/result.json
                filePath = fullPath;
              }
              
              const data = JSON.parse(fs.readFileSync(filePath, 'utf8'));
              const statusEmoji = data.status === 'success' ? 'âœ…' : 'âŒ';
              message += `| ${data.environment} | ${statusEmoji} ${data.status} | ${data.url} |\n`;
            });

            // ç’°å¢ƒå¤‰æ•°ã¨ã—ã¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
            core.exportVariable('DEPLOY_MESSAGE', message);

      - name: Write Summary
        uses: actions/github-script@v8
        with:
          script: |
            const message = process.env.DEPLOY_MESSAGE || '';
            await core.summary.addRaw(message).write();

      - name: Comment on PR
        uses: actions/github-script@v8
        if: github.event_name == 'pull_request' # PR ã®å ´åˆã¯ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ®‹ã™
        with:
          script: |
            const message = process.env.DEPLOY_MESSAGE || '';
            const body = message +
              `\n*Pusher: @${{ github.actor }}, Commit: ${{ github.event.pull_request.head.sha }}* \n` +
              `\n<!-- deploy-workers-with-bun-results -->`;


            // æ—¢å­˜ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ¢ã™
            const comments = await github.rest.issues.listComments({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo
            });

            const botComment = comments.data.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('<!-- deploy-workers-with-bun-results -->')
            );

            if (botComment) {
              // æ—¢å­˜ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ›´æ–°
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              // æ–°è¦ã‚³ãƒ¡ãƒ³ãƒˆã‚’ä½œæˆ
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: body
              });
            }
